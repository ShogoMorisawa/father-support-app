# 1) DBスキーマ（Rails想定・PostgreSQL）

> 目的：期日/顧客/案件/在庫/写真/操作履歴（Undo可）を一貫管理。  
> ポイント：`pg_trgm`でカナ/漢字/電話のクロス検索、`idempotency`で再送安全、`audit_logs`で逆操作。

## テーブル一覧（主な列のみ）

### customers（顧客）

- id (PK)
    
- name (varchar, **必須**)
    
- name_kana (varchar, ふりがな)
    
- phone (varchar) — **正規化しつつ保存**（ハイフン除去版も別列に）
    
- phone_normalized (varchar, index)
    
- address_line (text)
    
- memo (text)
    
- merged_into_id (fk nullable) … 重複統合でマージ先を指す
    
- created_at / updated_at  
    **Index**:
    
- `idx_customers_search_trgm` on (name, name_kana, phone) using gin (trgm)
    
- `idx_customers_phone_normalized` btree
    

### projects（案件／見積→作業化→納品）

- id (PK)
    
- customer_id (fk customers, **必須**)
    
- title (varchar) …「〇〇様 障子4枚 張替」など
    
- status (enum: `estimate`, `scheduled`, `in_progress`, `delivered`, `cancelled`)
    
- due_on (date, **作業化以降は必須**)
    
- location (varchar) 納入先・現場名など
    
- notes (text)
    
- created_at / updated_at  
    **Index**:
    
- `idx_projects_customer_id`
    
- `idx_projects_status_due_on` (status, due_on)
    

### project_items（案件内の明細：障子/網戸/襖ごと）

- id (PK)
    
- project_id (fk projects, **必須**)
    
- kind (enum: `shoji`, `amido`, `fusuma`, `other`)
    
- quantity (integer, **必須**, >=1)
    
- unit (varchar, 例: 枚／m)
    
- material_id (fk materials nullable) … 使用材料（紙/網/糊…）
    
- width_mm / height_mm (integer nullable) … サイズ管理したい場合
    
- price_cents (integer nullable) … 単価（税抜/税込はアプリ設定に依存）
    
- notes (text)
    
- created_at / updated_at  
    **Index**:
    
- `idx_project_items_project_id`
    

### materials（資材マスタ）

- id (PK)
    
- name (varchar, **必須**) 例: 「障子紙 かがやき」
    
- code (varchar) 任意の自社コード
    
- category (enum: `paper`, `net`, `glue`, `wood`, `other`)
    
- stock_unit (varchar) 例: `枚`, `m`, `本`
    
- threshold (integer, デフォ残量閾値) 例: 10
    
- default_per_item (numeric, 材料ごとの**標準使用量**：例“1枚あたり糊 0.2本”)
    
- notes (text)
    
- created_at / updated_at  
    **Index**:
    
- `idx_materials_name_trgm` gin (trgm)
    

### inventories（在庫）

- id (PK)
    
- material_id (fk materials, **必須**)
    
- quantity (numeric, **必須**) … 小数対応（m単位対応）
    
- location (varchar, 例: 倉庫A/車載）
    
- created_at / updated_at  
    **Unique**: (material_id, location)
    

### stock_movements（在庫の出入庫履歴＝**Undoの手がかり**）

- id (PK)
    
- material_id (fk materials, **必須**)
    
- delta (numeric, **必須**, ＋入庫／−出庫)
    
- reason (enum: `work_complete`, `manual_adjust`, `purchase`, `undo`)
    
- project_id (fk projects nullable) … 作業紐付け
    
- memo (text)
    
- actor (varchar) … 実行者（将来 multi-user）
    
- idempotency_key (uuid, **必須**, unique)
    
- correlation_id (uuid, **必須** 同一操作の束ねID)
    
- created_at  
    **Index**:
    
- `idx_stock_movements_material_created` (material_id, created_at)
    
- `uniq_stock_movements_idem` (idempotency_key unique)
    

### photos（ActiveStorageでもOK／ここは業務メタ）

- id (PK)
    
- project_id (fk) / project_item_id (fk nullable)
    
- kind (enum: `before`, `after`, `other`)
    
- original_blob_id (ActiveStorageの参照)
    
- width / height (integer)
    
- rotation (integer) … 横向き補正した場合
    
- created_at
    

### audit_logs（**すべての操作ログ & 逆操作情報**）

- id (PK)
    
- actor (varchar)
    
- action (varchar) 例: `project.complete`, `stock.adjust`, `customer.merge`
    
- entity_type (varchar) 例: `Project`, `Inventory`
    
- entity_id (uuid/integer)
    
- before (jsonb) … 差分用
    
- after (jsonb)
    
- inverse (jsonb) … **逆操作のパラメタ**（APIでそのまま叩ける形）
    
- idempotency_key (uuid, unique)
    
- correlation_id (uuid, index)
    
- created_at  
    **Index**:
    
- `idx_audit_logs_corr` (correlation_id)
    
- `uniq_audit_logs_idem` (idempotency_key unique)
    
- `idx_audit_logs_action_created` (action, created_at)
    

### merges（顧客の重複統合）

- id (PK)
    
- source_customer_id (fk customers)
    
- target_customer_id (fk customers)
    
- rule (enum: `auto_exact`, `suggested_partial`, `manual_forced`)
    
- created_at  
    **Unique**: (source_customer_id)
    

---

# 2) API設計（REST／JSON／Idempotency）

> ルール：**全変化系APIは`X-Idempotency-Key`必須**。クライアントはUUID発行して付与。  
> 失敗時は**同じキーで再送可**。サーバは処理結果をリプレイ。

## 共通レスポンス

```json
// 200系
{ "ok": true, "data": { ... }, "correlationId": "uuid" }
// 4xx/5xx
{ "ok": false, "error": { "code": "VALIDATION_ERROR", "message": "期日は必須です", "fields": {"due_on":"必須"} }, "correlationId":"uuid" }
```

## 主要エンドポイント（抜粋）

### 顧客検索（カナ/漢字/電話クロス）

`GET /api/customers?query=かがい&phone=0901234`

- 検索は `name/name_kana/phone_normalized` を横断（trgm + 先頭一致補助）
    

### 案件作成→作業化

- `POST /api/projects`
    

```json
{
  "customerId": 1,
  "title": "山田様 障子4枚張り替え",
  "status": "estimate",
  "items": [
    {"kind":"shoji","quantity":4,"unit":"枚","materialId":11,"notes":""}
  ],
  "notes": ""
}
```

- `POST /api/projects/:id/schedule`
    

```json
{ "dueOn": "2025-08-20", "location": "山田邸", "notes": "" }
```

- バリデーション：`dueOn` **必須**（チェック項目に合致）
    

### 作業完了（在庫減算を**サーバ側で一括**）

`POST /api/projects/:id/complete`

```json
{ "completedAt": "2025-08-21T09:30:00Z" }
```

- サーバ処理：
    
    - 各 `project_item` × `materials.default_per_item` ⇒ 出庫 `stock_movements (−)`
        
    - `audit_logs` に `inverse`: `{ "method": "POST", "path": "/api/projects/:id/revert-complete" }`
        
    - `correlation_id` を在庫・プロジェクト・監査で共通化
        

### 完了の取り消し（Undo）

`POST /api/projects/:id/revert-complete`

- サーバ処理：該当 `correlation_id` の `stock_movements` を反転（＋入庫）
    

### 在庫入荷

`POST /api/inventories/:materialId/receive`

```json
{ "quantity": 20, "location": "倉庫A", "purchasedAt": "2025-08-21" }
```

### 画像アップロード（事前署名URL）

- `POST /api/photos/presign` → URL返却
    
- PUT to S3
    
- `POST /api/photos/attach`
    

```json
{ "projectId": 123, "kind": "before", "blobKey": "..." }
```

---

# 3) DTO / 型定義（md版 → ts生成しやすい形）

```md
## Customer
id: number
name: string
nameKana?: string
phone?: string
phoneNormalized?: string
addressLine?: string
memo?: string

## ProjectItem
id: number
projectId: number
kind: "shoji" | "amido" | "fusuma" | "other"
quantity: number
unit?: string
materialId?: number
widthMm?: number
heightMm?: number
priceCents?: number
notes?: string

## Project
id: number
customerId: number
title: string
status: "estimate" | "scheduled" | "in_progress" | "delivered" | "cancelled"
dueOn?: string (YYYY-MM-DD)
location?: string
items: ProjectItem[]
notes?: string

## Material
id: number
name: string
code?: string
category: "paper" | "net" | "glue" | "wood" | "other"
stockUnit: string
threshold?: number
defaultPerItem?: number
notes?: string

## Inventory
materialId: number
location: string
quantity: number
updatedAt: string

## Photo
id: number
projectId: number
projectItemId?: number
kind: "before" | "after" | "other"
urlSmall: string
urlMedium: string
urlOriginal: string
width: number
height: number
rotation?: number
```

---

# 4) Undo実装ポリシー（逆操作の作り方）

1. **コマンド単位**で `correlation_id` を採番（例：作業完了ボタン押下 → 1つの相関ID）。
    
2. その相関IDの中で行われた副作用（在庫出庫、案件status変更）を**監査に束ねて保存**。
    
3. `audit_logs.inverse` に**逆API**を持たせる（method + path + payload）。
    
4. 履歴UIは `/history` で直近10件表示：
    
    - 「山田様の作業完了」 → “元に戻す”（`inverse` を即時POST）
        
5. **在庫の完全復元**は `stock_movements` の**反転挿入**で実現。
    

---

# 5) 入力検証（フロント＝Zod / サーバ＝Rails）

- 共通ルール（要点）
    
    - Project: `status !== estimate` → `dueOn` **必須**
        
    - ProjectItem: `quantity >= 1`
        
    - Phone: 半角数字に正規化保存（`phone_normalized`）
        
    - Material: `defaultPerItem >= 0`
        
- エラー表現は**一行日本語**＋`fields`で箇所特定（共通フォーマット）
    

---

# 6) エラーメッセージ集（日本語UX・短文）

- 通信失敗：**「通信に失敗しました。再試行してください」**
    
- 期限未設定：**「納品期日は必須です」**
    
- 入力不備：**「入力内容を確認してください」**
    
- 重複顧客：**「同名・同電話の顧客が見つかりました。統合しますか？」**
    
- 在庫不足：**「在庫が不足しています。入荷または数量を調整してください」**
    
- 画像失敗：**「画像のアップロードに失敗しました。もう一度お試しください」**
    
- 取り消し完了：**「直前の操作を元に戻しました」**
    

---

# 7) 発注メール テンプレ（v1 MVP）

> 件名：`【発注】<材料名> <数量><単位>（<希望納期>）`  
> 宛先：仕入先（seedsで1社）

```
<仕入先名> ご担当者様

お世話になっております。<屋号/会社名>の<担当者名>です。
下記の通り、資材の発注をお願いいたします。

■発注内容
- 材料名：<材料名>
- 数量：<数量><単位>
- 希望納期：<YYYY/MM/DD>
- 納品先：<住所 or 現場名>
- 参考案件：<案件タイトル or 顧客名>（任意）

■備考
<自由記入>

ご確認のほど、よろしくお願いいたします。

--
<屋号/会社名>
<担当者名> / <電話番号>
<住所>
```

---

# 8) seeds（最小セット・YAML/JSONどちらでも）

```yaml
materials:
  - { name: "障子紙 かがやき", category: "paper", stockUnit: "枚", threshold: 10, defaultPerItem: 1 }
  - { name: "襖紙 白無地", category: "paper", stockUnit: "枚", threshold: 8, defaultPerItem: 1 }
  - { name: "網戸ネット 24メッシュ", category: "net", stockUnit: "m", threshold: 10, defaultPerItem: 1.2 }
  - { name: "でんぷん糊", category: "glue", stockUnit: "本", threshold: 5, defaultPerItem: 0.2 }

suppliers:
  - { name: "○○紙材", email: "order@example.com", phone: "0312345678", address: "東京都..." }

customers:
  - { name: "山田 太郎", name_kana: "ヤマダ タロウ", phone: "090-1234-5678", phone_normalized: "09012345678", address_line: "大分県別府市..." }
  - { name: "佐藤 花子", name_kana: "サトウ ハナコ", phone: "090-0000-1111", phone_normalized: "09000001111", address_line: "大分県..." }

projects:
  - customer_ref: "山田 太郎"
    title: "障子4枚 張替"
    status: "scheduled"
    due_on: "2025-08-20"
    items:
      - { kind: "shoji", quantity: 4, unit: "枚", material_ref: "障子紙 かがやき" }
```

> seeds実行時に `*_ref` を名前解決してIDへ。

---

# 9) 検索（カナ/漢字/電話）実装メモ

- Postgres拡張：`CREATE EXTENSION IF NOT EXISTS pg_trgm;`
    
- ふりがなは保存時に**カタカナ正規化**（長音/半角→全角）
    
- 電話は `phone_normalized = phone.gsub(/\D/, "")`
    
- クエリ：`WHERE name ILIKE '%q%' OR name_kana ILIKE '%q%' OR phone_normalized LIKE 'q%'`
    

---

# 10) 画面構成とルーティング確定版（Next.js）

- `/home`：今日の予定・在庫アラート・最近の履歴（Undo導線）
    
- `/calendar`：案件カレンダー（status: scheduled/in_progress）
    
- `/tasks`：案件一覧（フィルタ：期日/顧客/ステータス）
    
- `/projects/:id`：案件詳細（完了ボタン／写真Before/After）
    
- `/inventory`：在庫一覧（閾値バッジ／入荷ショートカット）
    
- `/customers` → `/customers/:id`：履歴・案件一覧
    
- `/history`：監査ログ10件＋「元に戻す」
    
- 戻る導線：左上固定
    

### フロントの状態管理（Zustand + React Query）

- `useSessionStore`：ローカルロック設定（生体/PIN）
    
- `useUndoStore`：直近の`audit_log`のキャッシュ（UI即時反映→失敗ならロールバック）
    
- React Queryは**mutationごとに `X-Idempotency-Key`** を付与
    

---

# 11) QAチェック（テスト観点の追記）

-  見積→作業化で `dueOn` 未設定は**保存不可**
    
-  作業完了→在庫自動減算→`/history`からUndo→在庫/ステータス完全復元
    
-  在庫入荷（＋）→`stock_movements`生成→Undoで元に戻る
    
-  写真：横向き補正・同時3枚・1600px圧縮後でも判読性OK
    
-  顧客自動統合：完全一致は自動／片一致は提案／住所矛盾は拒否
    
-  再送：同じ`X-Idempotency-Key`で二重登録が**発生しない**
    
-  閾値割れバッジ：`threshold`未設定はバッジ非表示
    

---

# 12) 運用メモ（最低限）

- S3ライフサイクル例：`photos/original/**` を **90日で低頻度**、**365日でGlacier**
    
- バックアップ：Postgres **日次スナップショット**＋**復旧手順1枚**（ダンプ→リストア→マイグレ適用）
    
- 監視：Sentry（バック/フロント）＋APIアクセスログ（Rails標準 + request_id=correlation_id）
    

---

# 13) すぐ着工するための「順番」

1. **DBマイグレ**（上記テーブル）＋ `pg_trgm` 有効化
    
2. **/api スケルトン**（DTO固定 → ダミーJSON返す）
    
3. **IdempotencyFilter** 実装 → 全mutationに必須化
    
4. **作業完了→在庫減算→Undo** の**縦一本**実装（MVPの幹）
    
5. 顧客検索（trgm）→案件作成→作業化（期日必須）
    
6. 画像アップロード（署名→添付）
    
7. Home/Calendar/Inventory/History の**一覧4画面**
    
8. 発注メール（テンプレ送信）
    

---

# 最終精査レポート（要点だけ）

## ✅ 仕様適合チェック（抜粋）

- 期日未設定ガード：`/schedule`で必須 → **適合**
    
- Undo：相関ID＋逆操作 → **適合**（後述の補強推奨あり）
    
- カナ/漢字/電話クロス検索：`pg_trgm + 正規化` → **適合**
    
- 重複顧客：`merges`と`merged_into_id`で指し替え → **適合**
    
- 在庫：`stock_movements`ベース＋`inventories`キャッシュ → **適合**
    
- 画像：事前署名URL＋圧縮・横向き補正 → **適合**
    

---

## 🟥 High（必ず入れると事故率が激減）

1. **数量・金額の型と丸め**
    
    - `quantity/default_per_item` は **DECIMAL(12,3)**（Rails `:decimal, precision:12, scale:3`）。
        
    - 在庫の四則演算は**必ずトランザクション内**＋**チェック制約**（`quantity >= 0`）。
        
    - 価格は**税込/税抜の方針を設定**（小数計算禁止／**整数cents**に統一）。  
        ✅ _修正案：_ `inventories.quantity` と `stock_movements.delta` を `decimal(12,3)` に、`project_items.price_cents` は `integer` に固定。
        
2. **Undoの一貫性（“全部戻るor何も戻らない”）**
    
    - 1操作＝1相関ID＝**単一DBトランザクション**で副作用を束ねる。
        
    - `audit_logs.inverse` は**保存**するが、**“現在のDB状態依存”の計算は入れない**（時間が経っても確実に戻せる形）。  
        ✅ _修正案：_ `projects.complete` 実行時に、出庫した各行の **反転`stock_movements`ペイロードを inverse に保存**。
        
3. **楽観ロック or 冪等＋再読込**
    
    - 在庫や案件の同時操作を考慮し、`lock_version`（Railsの楽観ロック）を `inventories/projects` に付与。
        
    - 失敗時は`HTTP 409`で返し、クライアントは**再読込して再操作**。  
        ✅ _修正案：_ `t.integer :lock_version, null:false, default:0` を主要テーブルへ。
        
4. **電話・カナの正規化を“保存前”に強制**
    
    - `phone_normalized` 一意性は将来の多テナントを考慮し**アカウント別**に。  
        ✅ _修正案：_ `before_validation`で正規化、DB側は `CHECK (phone_normalized ~ '^[0-9]+$')`。
        
5. **将来の複数ユーザー（家族・従業員）に備えて今だけ仕込み**
    
    - 今のうちに **`account_id`** を全テーブルに入れておく（既定値`1`）。後からの大改修を回避。  
        ✅ _修正案：_ 全テーブルに `account_id: bigint NOT NULL DEFAULT 1` + 複合ユニーク・インデックスは `(account_id, ...)` で作成。
        

---

## 🟧 Medium（入れると“運用が爆楽”）

6. **在庫の“算定元”を真にする**
    
    - 真実は `stock_movements`、`inventories`は**集計キャッシュ**。
        
    - 起動時/日次で **整合性チェックJob**（`sum(movements)=inventories`）を1本だけ用意。  
        ✅ _修正案：_ `/admin/health` か rake task で差分検知＆自動修復オプション。
        
7. **顧客マージの参照整合性**
    
    - マージ時、FKを**一斉にマージ先へ付け替え**（`projects.customer_id` など）。
        
    - `merged_into_id` を持つレコードは**UIから非表示**、検索では**候補としてのみ提示**。  
        ✅ _修正案：_ サービス層 `Customers::Merge` を1ユースケース化（トランザクション内で付け替え＋監査）。
        
8. **写真メタはActiveStorageに寄せる**
    
    - 追加の `photos` テーブルは **最小限**にして、寸法/向きはASの`metadata`でOK。  
        ✅ _修正案：_ `photos.rotation/width/height` を**削減可**（残すなら“業務上の種別”だけ）。
        
9. **スケジュールの“時間”扱い**
    
    - 今は `due_on(date)` でOKだが、**現場の訪問時間**が要るなら `due_at(timestamp)` を将来追加できる設計に。  
        ✅ _修正案：_ APIは `dueOn` のまま、DBは `due_on`＋将来の `due_at` 追加余地をコメントで明記。
        
10. **検索の“先頭一致ブースト”**
    

- `trgm` は便利だがノイズも拾う。**先頭一致（`LIKE '山田%'`）＞ 部分一致（`%田%`）**の並び替えを実装して体感爆上げ。  
    ✅ _修正案：_ SQLで `CASE WHEN name_kana LIKE 'q%' THEN 0 ELSE 1 END, similarity(...) DESC`。
    

---

## 🟨 Low（余裕があれば）

11. **OpenAPI（rswag）で型を自動同期**
    

- Rails → OpenAPI → TS 型自動生成で**DTOの手同期ミスを撲滅**。
    

12. **発注メールの“送信確実化”**
    

- **アウトボックスパターン**（DBに`outbox`→ジョブが送信）で通信途絶時でも再送OK。
    

13. **S3 事前署名の制限**
    

- `content-type/最大サイズ/有効期限/キー接頭辞` を署名に埋めて**勝手アップロード防止**。
    

14. **PWA実機運用メモ**
    

- iOSのPWA制約に備え、**“インストール方法”チュートリアル**をアプリ内に1画面用意。
    

---

## 🔧 「差分」だけサクッと DDL（要点）

- 数量型修正：
    
    - `change_column :inventories, :quantity, :decimal, precision: 12, scale: 3, null: false, default: 0`
        
    - `change_column :stock_movements, :delta, :decimal, precision: 12, scale: 3, null: false`
        
    - `add_check_constraint :inventories, "quantity >= 0", name: "chk_inventories_quantity_nonneg"`
        
- 楽観ロック：
    
    - `add_column :inventories, :lock_version, :integer, null: false, default: 0`
        
    - `add_column :projects, :lock_version, :integer, null: false, default: 0`
        
- アカウント対応：
    
    - `add_column :<all>, :account_id, :bigint, null: false, default: 1`
        
    - 主要ユニークを `(account_id, ...)` に張替
        
- 電話正規化：
    
    - `add_check_constraint :customers, "phone_normalized ~ '^[0-9]*$'", name: "chk_customers_phone_digits"`
        

---

## 🎯 結論（やることリスト）

-  数量/価格の**型と丸め**を確定（DECIMAL＋cents）
    
-  **楽観ロック**と**トランザクション束ね**でUndoの“全戻し”を保証
    
-  `account_id` を全テーブルに追加して将来の多ユーザーに備える
    
-  顧客マージの**ユースケース化**（FK付け替え＋監査）
    
-  検索の**先頭一致ブースト**で現場UXを上げる
    
-  画像の**事前署名の制限**と**S3ライフサイクル**（既定値）を見直す
    
-  日次で**在庫整合性チェック**のジョブ or タスクを1本用意

---

# 外部AI向けハンドオフ最終仕上げ

## 1) リポジトリ最上位に置く README（実装手順の一本化）

以下を`README.md`の最上段に追加：

**目的と完成定義（MVP）**

- 完了ボタン=在庫減算m・納品タスク生成・閾値判定・Undo無制限（履歴画面から逆操作）を満たすこと。 張り替え事業支援アプリ｜仕様 v1.2 張り替え事業支援アプリ｜仕様 v1.2
    

**着工順**（そのまま実行）

1. DBマイグレーション & `pg_trgm`有効化
    
2. APIスケルトン（DTO固定、ダミーJSON）
    
3. Idempotency Filter 実装（全Mutationで必須）
    
4. 「作業完了→在庫減算→Undo」の縦一本を完成
    
5. 顧客検索／案件作成／作業化（期日必須）
    
6. 画像：事前署名→添付
    
7. Home / Calendar / Inventory / History の一覧4画面
    
8. 発注メール送信（テンプレ） 実装前のさいごの「埋め」
    

**受け入れ基準（MVP）**

- 期日未入力では作業化できない。
    
- 完了→在庫自動減算→履歴からUndoで完全復元（連続Undo可）。
    
- 閾値下回り素材が在庫画面で上位表示＋警告アイコン。 張り替え事業支援アプリ｜DBスキーマ v1.2 張り替え事業支援アプリ｜仕様 v1.2
    

## 2) API契約を一枚に（OpenAPIの骨子）

`openapi.yaml`に最低限の3本を定義：

- `POST /projects/{id}/complete`（原子的処理）
    
- `POST /projects/{id}/revert-complete`（逆操作）
    
- `GET /deliveries?status=pending`（納品予定カード/一覧用） 張り替え事業支援アプリ｜仕様 v1.2
    

**共通仕様**

- 全Mutationで `X-Idempotency-Key` 必須、同キー再送でリプレイ。
    
- 409は楽観ロック衝突としてクライアントに再読込を促す。 実装前のさいごの「埋め」
    

## 3) マイグレーション順とチェックリストを同梱

`/docs/migrations.md` に順番と目的を書き出し：

- customers → projects → project_items → tasks → task_used_materials → inventory_adjustments → material_suppliers → undo_events/steps → ActiveStorage → インデックス/CHECK。各テーブルの**必須CHECK**（quantity ≥1、scheduled_delivery_date NOT NULLなど）も併記。 張り替え事業支援アプリ｜DBスキーマ v1.2 張り替え事業支援アプリ｜DBスキーマ v1.2
    

## 4) データモデリングの“運用ルール”を明文化

`/docs/domain-rules.md` に次を明記：

- 在庫の真実は**履歴**（inventory_adjustments / stock_movements 相当）、現在値はキャッシュ。差分チェックJobを日次で実行。 実装前のさいごの「埋め」
    
- 顧客自動統合：`kana`＋`phone`完全一致のみ自動、住所不一致は自動統合禁止。統合時は案件/タスク/写真を全移管。 張り替え事業支援アプリ｜DBスキーマ v1.2 張り替え事業支援アプリ｜仕様 v1.2
    

## 5) 画像アップロード運用（サーバ/フロントの責務線引き）

`/docs/photos.md`：

- 事前署名URLで直PUT、成功後にAPIでメタ登録。
    
- 受信後に**圧縮（長辺1600px）＋EXIF回転補正**を適用。
    
- EXIF日時があればタイムラインに反映。 張り替え事業支援アプリ｜仕様 v1.2
    

## 6) AWS最小構成の**固定レシピ**（迷わせない）

`/infra/README.md` に「これを作る」リストを固定：

- App Runner（Rails）＋RDS Postgres(Multi‑AZ/PITR)＋S3(photos/public-assets)＋SES（サンドボックス解除前提）＋CloudWatch Logs/Budgets＋Parameter Store。併せてS3 CORS/Lifecycleの貼るだけJSONを同梱。 実装前のAWS設計 実装前のAWS設計 実装前のAWS設計
    
- セキュリティの初期原則：RDSは非公開、App Runner→VPC接続、S3はVPCエンドポイント/KMS、SESはSPF/DKIM/DMARC設定。 実装前のAWS設計 実装前のAWS設計
    

## 7) 受け渡し用 .env.catalog（環境変数の見取り図）

`/docs/env.md` にキー一覧を記載（例）：

- `DATABASE_URL`、`RAILS_MASTER_KEY`、`AWS_REGION`、`S3_BUCKET_PHOTOS`、`S3_BUCKET_PUBLIC`、`SES_SENDER`、`CORS_ALLOWED_ORIGINS`、`IDEMPOTENCY_TTL_SEC` など。  
    ※ 値の保存先は Parameter Store/Secrets Manager（直書き禁止）。 実装前のAWS設計
    

## 8) 画面と仕様の“答え合わせ”スクショリスト

`/docs/acceptance.md` に、Home/Calendar/Tasks/Inventory/Customers/History で満たすべきUI要件を箇条書き（例：在庫タブ、閾値下回りの上位表示、Undo可視化、納品予定カードなど）。 張り替え事業支援アプリ｜仕様 v1.2 張り替え事業支援アプリ｜仕様 v1.2

---

# いま埋めると“詰まりゼロ”になる最後の指摘（短く）

1. **OpenAPIのyaml**が未添付 → 3エンドポイントだけでも定義して同梱（上記§2）。
    
2. **IaCテンプレ**（最小）→ 後からでもOKだが、S3 CORS/LifecycleのJSONは既に記述あり。`infra/`に配置して参照できる状態に。 実装前のAWS設計
    
3. **テーブル列挙→CHECKの写経**は十分だが、実装者が迷わないよう**“必須/nullableの理由”**を1行コメントで各テーブルに追記（例：`scheduled_delivery_date`は作業化の必須期限）。 張り替え事業支援アプリ｜DBスキーマ v1.2
    
4. **Undoの原子性**のベストプラクティスを README に明記（「単一トランザクション＋逆操作ペイロード保存」）。 実装前のさいごの「埋め」
    
5. **在庫の真実/集計キャッシュ**の二層構造を“原則”として別紙化（§4で対応）。