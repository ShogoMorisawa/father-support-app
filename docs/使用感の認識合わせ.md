# （父の実務フロー → アプリが担う範囲）

1. 電話受領
    

- 住所・電話・氏名・メモをサクッと入力（既存顧客なら検索→自動補完）。
    
- → 即座に**見積もり予定**を日時指定で登録。
    
- カレンダー（JST）に表示。“今日/明日/週”の俯瞰＋地図リンク。
    

2. 見積もり訪問
    

- 金額・点数・工期目安・必要資材（概算）を入力。
    
- **契約成立**で「案件（Project）」生成 → **作業リスト（Tasks）**に “何を何枚” を登録。
    
    - ※ここで「見積もり金額」も確定保存。
        
    - 見積もりフェーズと作業/納品は**独立**（見積イベントは“案件の起点”だが、その後は別ラインで進む）。
        

3. 作業
    

- 作業が終わったら**完了**操作。
    
- 完了時に使った資材を即時**在庫減算**。
    
- **閾値未満ならアラート**を出し、ワンタップで**発注メールのテンプレ**を生成（コピー or メーラ起動）。
    

4. 納品
    

- 納品予定（Delivery）を別途管理（見積と独立・作業とも独立）。
    
- ホームの「納品予定カード（3件）」に出す。
    

5. どこでも在庫
    

- 見積外出中でも**在庫の残量を即確認**できる“クイック在庫ビュー”が欲しい（検索・しきい値バッジ）。
    

> 既存仕様との整合：
> 
> - 変化系はX-Idempotency-Key必須／409=競合／Undoは逆操作保存（現状どおり）。
>     
> - 「見積もり予定」は**新しいエンティティ**として追加し、作業・納品と分離するのが自然。
>     

---

# 仕様に落とす（最小追加でいける設計）

## 状態機械（主要遷移）

- Lead（電話受領）  
    → EstimateScheduled（見積予定登録）  
    → EstimateDone(accepted=true/false)  
    → if accepted → Project(in_progress) + Tasks[]
    
- Project は独立に進行：  
    in_progress → delivery_scheduled（任意） → completed
    
- Deliveries は Project と**疎結合**（複数可／後から追加・変更可）。
    
- Undo原則：単一操作＝単一Tx・逆操作保存（Estimate/Project/Deliveries/Inventory すべて対象）。
    

## データ（追加・拡張の最小セット）

- estimates（見積イベント）
    
    - id, customer_id, scheduled_at, address_snapshot, phone_snapshot, memo
        
    - result: { accepted:boolean, price_cents, items:[{material_id, qty_planned}]}
        
- projects / tasks（既存方針踏襲）
    
    - task.items で使用資材（qty_used DECIMAL(12,3)）
        
- materials / inventories
    
    - materials.threshold_qty, current_qty
        
- deliveries（既存）
    
    - project_id, date, note
        
- audit_logs（逆操作payload）, idempotency_keys（結果リプレイ）…既存方針を本実装へ
    

---

# UIへの反映（MVPで効く“最小”）

- Home：
    
    - ① 納品予定（3件）カード（既存）
        
    - ② **見積もり予定（3件）カード**を追加（今日・明日・今週の要約／地図リンク）
        
    - ③ 右上に**在庫クイックビュー**アイコン（低在庫バッジ数を表示→モーダルで一覧+検索）
        
- /estimates（カレンダー/リスト）
    
    - 新規登録（電話受領からも遷移）→ 日時・顧客情報
        
    - “訪問完了/契約成立”チェックで Project + Tasks を一括生成
        
- /tasks（既存）
    
    - 完了→在庫即減算→**lowStock**ならトースト＋「発注メールをひらく」
        
- /history（既存）
    
    - Estimate登録/成立/取消、Project生成、Deliveries変更、Complete/Undo を一元表示
        

---

# ここからの「小PR」プラン（30〜90分粒度）

**PR1｜OpenAPI：見積エンドポイントの提案（実装前の最小差分）**

- 追加:
    
    - `GET /estimates?from&to`（JST日付範囲）
        
    - `POST /estimates`（電話受領→予定作成、Idempotent）
        
    - `POST /estimates/{id}/complete`（accepted/price/items を確定、受理なら Project+Tasks 作成）
        
    - 既存 `/deliveries` `/history` は据え置き。
        
- 返却は既存の `{ ok, data: { items } }` に準拠。
    
- 目的：**唯一の正（openapi.yaml）に先に合意を刻む**。
    
- ブランチ: `chore/openapi-estimates`
    
- コミット: `chore(openapi): 見積API（list/create/complete）を提案として追加`
    

**PR2｜フロント：見積カードのモック & ルータ下地**

- Home に「見積もり予定（3件）」カード（/api/estimates モック）。
    
- /estimates ページの骨組み（リスト+作成モーダル）。
    
- ブランチ: `feat/frontend/estimates-card`
    
- コミット: `feat(frontend): 見積もり予定カードと /estimates 骨組み（モック接続）`
    

**PR3｜フロント：在庫クイックビュー**

- 右上アイコン＋低在庫バッジ（閾値下回り件数）。
    
- モーダルで検索（pg_trgm想定のUIだけ先に実装）
    
- ブランチ: `feat/frontend/inventory-quickview`
    
- コミット: `feat(frontend): 在庫クイックビュー（低在庫バッジ＋検索）`
    

**PR4｜Railsマイグレ：estimates & thresholds**

- tables: `estimates`, `estimate_items`, `materials.threshold_qty` 追加。
    
- pg_trgm 有効化（customers name/phone 検索用）。
    
- ブランチ: `feat/backend/migrations-estimates`
    
- コミット: `feat(db): estimates系テーブルとmaterials閾値・pg_trgm有効化`
    

**PR5｜在庫アラート & 発注メール下地（モック→本実装に活かす）**

- 完了APIのレスポンスに `lowStock: [{materialId, name, current, threshold}]`（提案）
    
- UIトーストに「メールを開く」→ 件名/本文テンプレを生成（宛先は手入力）
    
- ブランチ: `feat/projects/complete-lowstock`
    
- コミット: `feat(projects): 完了時にlowStock情報とメールテンプレ提示`
    

**PR6｜Idempotency永続化 & Undo一連テスト（Rails側）**

- `idempotency_keys` テーブル＋結果リプレイ
    
- complete / revert-complete の単一Tx + inverse 保存
    
- ブランチ: `feat/backend/idempotency+undo`
    
- コミット: `feat(api): Idempotency永続化とcomplete/revertの単一Tx実装`
    

---

# 仕様変更の“理由”（提案の正当性）

- 見積は実務の入口で、**作業/納品と独立**の“予定”。モデル分離により
    
    - カレンダー最適化（JST・地図リンク）
        
    - 契約不成立の分岐も自然に扱える
        
    - UndoやIdempotencyを**操作単位**で正しく扱える
        
- 在庫は**外出時の即時判断**が最重要。クイックビュー＋アラート＋メール導線で“現場の1タップ”を実現。