## 0) ゴール & 前提

- 現場のやり方は崩さず、**在庫・進捗・納品記録・発注**を最小の手間で補助。
    
- **スマホ専用**。見積もり中は**入力せず**在庫だけ一瞥。
    
- 在庫は**m単位**管理。標準換算（約◯回）は設定が入った時のみ表示。
    

---

## 1) ナビ & 画面

- **ホーム**（中核）
    
    - 上：今日の予定（例「14:00 モリサワ様 見積」「16:00 カワサワ様 納品」）
        
    - カード4枚：
        
        1. カレンダー（見積/納品）
            
        2. 作業一覧（納品期日順）
            
        3. 在庫状況（不足時はバッジ）
            
        4. 顧客一覧（最近更新3件プレビュー）
            
    - 追加（v1.2）：**納品予定カード**（今後3件をD順表示→「一覧へ」）
        
- **カレンダー**
    
    - 見積=橙／納品=緑／作業=青(薄)。
        
    - 日付タップ→当日予定のモーダル＋「予定追加」。
        
    - 見積作成時は**納品期日必須**。
        
- **作業一覧（現場モード）**
    
    - 納品期日昇順（超過は最上段・赤枠）。
        
    - 行：「期日バッジ／顧客・種別・材料・数量／[地図][完了]」。
        
    - 完了＝**魔法ボタン**（在庫減算m・納品タスク生成・閾値判定→発注導線）。
        
    - **Undo無制限**（後述）。
        
- **在庫一覧**
    
    - タブ：「障子」「網戸」（襖は記録のみ）。
        
    - 行：名前／残量m／標準換算（設定時のみ）／閾値状態／[詳細][発注]。
        
    - 入荷は**＋m**（ロール→m換算ショートカット）。
        
    - **調整履歴必須**（理由・メモ）／**不足は上位表示＋アイコン**／ホーム在庫カードにバッジ。
        
- **顧客→案件履歴→案件詳細**
    
    - 顧客一覧：**カナ・漢字・電話**横断検索、最終対応日降順。
        
    - 顧客詳細：氏名（漢字＋カナ）／住所（地図リンク）／メモ／案件履歴（納品日順）。
        
    - 案件詳細：見積/作業/納品タイムライン、**納品写真（複数一括・圧縮・向き補正・撮影時刻反映）**、ラインアイテム概要。
        

---

## 2) v1.2 の新規/強化点（要点）

### A. **納品予定の見える化**

- ホームに**「納品予定」カード**（直近3件・D順）。
    
- 任意で**納品一覧**画面（`delivery tasks pending` を日付昇順）。
    

### B. **顧客の自動統合ルール（重複マージ）**

- **自動統合**：`kana 完全一致` **かつ** `phone 完全一致`。
    
- **統合提案**（手動確認）：片方のみ一致。
    
- **自動統合しない**：住所が両者にあり**不一致**の場合（警告表示）。
    
- 統合時は**案件・タスク・写真**をすべて移管、片方を論理削除。
    

### C. **Undo の見える化**（制限時間なし）

- 直近操作の**通知に「元に戻す」**ボタン。
    
- **履歴画面**：直近10件の操作を一覧（対象別フィルタ／個別[元に戻す]）。
    
- Undoは**逆操作**（在庫加算→履歴追記→タスク状態戻す 等）で実行。
    

### D. **最終対応日の非正規化（高速化）**

- 顧客の `last_activity_at` を**サーバ側一元管理**（作業完了/納品完了/案件完了で更新）。
    
- 顧客一覧のソートはこの値で実施→**高速表示**。
    

### E. **標準換算の上書き（精度向上）**

- グローバル設定の `標準m/枚（障子/網戸）` に加え、  
    **材料ごとの上書き値**（任意）を持てる。
    
- 換算は：`材料の上書き値 ?? グローバル設定 ?? 非表示（—）`
    

---

## 3) 写真アップロード（確定）

- **複数一括**、**自動圧縮**（長辺1600px目安）、**EXIF回転補正**。
    
- EXIF日時があれば**タイムライン**に反映（なければアップ時刻）。
    
- 案件（Project）に紐づけ。**納品前後どちらでも追加OK**。
    

---

## 4) 通知 & バッジ

- 作業完了時：在庫閾値判定 → **「残り約3回分」**などをトースト＋在庫へジャンプ。
    
- 在庫一覧：閾値以下の素材は**上位表示＋アイコン**。
    
- ホーム在庫カード：**不足バッジ**（件数）。
    

---

## 5) ルール/技術（変更なし + 明文化）

- **期日未設定ガード**：見積→作業化時は**納品期日必須**。
    
- **UTC保存/JST表示**：日時はDB=UTC、UI=JST。
    
- **トランザクション**：作業完了時の**在庫減算＋状態更新＋履歴記録**は不可分。
    
- **標準m/枚・閾値が空**でもUIは壊れず「—」表示、警告は出さない。
    

---

## 6) データ差分（v1.1 → v1.2）

- `customers`
    
    - `last_activity_at`（既に設計済・更新トリガをサービス層に集約）
        
- `materials`
    
    - 追加：`standard_len_override_m` (nullable) … 材料ごとの標準m/枚の上書き
        
- **自動統合フラグ**（実装はロジック。必要なら）
    
    - `customers.merge_hint_state`（0:なし,1:提案中,2:保留）※任意
        
- **納品一覧**は既存 `tasks (type=納品,status=未実施)` で取得（新テーブル不要）
    
- **Undo**は v1.1 の設計通り（ログ + 逆操作）
    

---

## 7) 代表API（差分のみ）

- GET `/deliveries?status=pending&order=date.asc`  
    → 納品予定一覧（ホームの「一覧へ」で利用）
    
- POST `/customers/merge`  
    → `source_customer_id` を `target_customer_id` に統合（住所矛盾時は 409）
    
- GET `/history?limit=10&filter=inventory|task|project`  
    → Undo 履歴
    

---

## 8) 最小テスト（v1.2 追加分）

- 顧客自動統合：`kana+phone`完全一致→自動／片一致→提案／住所矛盾→阻止。
    
- Undo：作業完了→Undo→在庫・履歴・タスク状態が**完全復元**（連続UndoもOK）。
    
- 納品予定カード：3件表示→一覧遷移→日付昇順。
    
- 標準換算の上書き：材料に上書き値が入るとそれを採用、未設定はグローバル、両方空は非表示。
    
- 在庫バッジ：閾値下回り素材が**ホームに件数表示**＆一覧上位。